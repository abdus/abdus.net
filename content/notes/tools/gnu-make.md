---
title: "Make and Makefile"
date: 2020-08-10T19:54:34+05:30
draft: false
tags: [build-tools, devtools]
categories: [tools]
sources:
  - https://www.cs.colby.edu/maxwell/courses/tutorials/maketutor/
  - https://www.gnu.org/software/make/manual/make.html
  - https://www.gnu.org/software/make/
---

<!--

::Annotation Guide::
~~~~~~~~~~~~~~~~~~~~

* `em` is the modifier

1. em (_text_) - blue circle
2. strong (**text**) - yelow highlight
3. del (~~text~~) - red strike-through

4. em > em (_*text*_) - blue underline
5. em > strong (_**text**_) - lawngreen box
6. em > del (_~~text~~_) - red cross-off
-->

`make` is a tool responsible for **generating binary and other non-source
files** of a program from the program's source.

`make` can be used to compile source code of **any language**.

### Features

- _enables user to build and install_ software without knowing the details of
  that specific software
- _compiles source files as needed_. can relate to _**hot-reloading**_.
- `make` is also capable of _installing and uninstalling_ packages.

A _Makefile_ contains **instructions** for `make` to run. A series of
instructions are known as **a rule**. A Makefile also describes relationship
among files.Example of a simple _rule_:

```makefile
target … : prerequisites …
        recipe
        …
        …
```

- **target** is usually the **name of the file** that is generated by a program.
  This file generally is an executable or object file.
  A target can also be the **name of an action** to carry out, sucj as `clean`.
- **prerequisite** is a file that is used as input to create _target_.
- **recipe** is an action `make` caries out.

> `make` uses tab for _**indentation**_. Failing to use it would throw an _*error*_

### Makefile Processing

- by default, starts with _**first target**_. also known as default _goal_
- `make` must process rules the target depends on
- recompilation is done only when **target is older than source** files; or
  when _target_ does not exists

### Variables

- allows **storing data in variable**
- variable declaration example: _**`objects = main.o kbd.o`**_.

```makefile
objects = main.o kbd.o

edit : $(objects)
        cc -o edit $(objects)
main.o : main.c defs.h
        cc -c main.c
kbd.o : kbd.c defs.h command.h
        cc -c kbd.c
clean :
        rm edit $(objects)
```

### Implicit Rules

`make` has an _**implicit rule for updating `.o` file**_ from a correspondingly
named `.c` file using `cc -c` command.

when a `.c` file is used through implicit rule, it is also added to the
list of prerequisites. Hence, _**`.c` files can be omitted from
prerequisites' list**_.

Example:

```makefile
objects = main.o kbd.o command.o display.o

edit : $(objects)
        cc -o edit $(objects)

main.o : defs.h
kbd.o : defs.h command.h
command.o : defs.h command.h
display.o : defs.h buffer.h

.PHONY : clean
clean :
        rm edit $(objects)
```

when using implicit rules, an alternate way of writing Makefile can be used.
in this type of Makefile, entries are _**grouped by their prerequisites**_
instead of by their targets

Example:

```makefile
objects = main.o kbd.o command.o display.o

edit : $(objects)
        cc -o edit $(objects)

$(objects) : defs.h
kbd.o command.o files.o : command.h
display.o : buffer.h
```

### Cleaning Directory

`make` can clean a given directory. for that Makefile should have an
explicit _*.PHONY*_ target.

> .PHONY prevents `make` to confuse it with an actual file target
> and _causes it to continue_ in spite of errors from `rm`.

taget `clean` can be executed by **passing it as an arg** to `make`

`clean` _**should not be placed**_ at top of the Makefile. Otherwise it would
become global target and will be executed by default.

```makefile
.PHONY : clean
clean :
        -rm edit $(objects)
```

### what a Makefile may contain

1. **variable definitions**
2. **directives** (instruction for make to do something special while
   reading the makefile)
   - Reading another makefile
   - deciding whether to ignore a part of Makefile
3. **comments** (starts with `#`). for multiline comment, a _backslash_ should
   be used at breakpoints

- _**Long lines can be splitted into multiple lines using backslash**_

### Including other Makefile

- `make` can read multiple Makefiles which are added using `include` directive.
filenames can contain shell file name patterns.
- if included file is empty, `make` _does nothing_.
   ```makefile
   include foo *.make $(bar)
   ```
- when path of file is not absolute, and the file is not found in current dir,
`make` looks for it in some other places(in following order).
    1. dirs **mentioned with -I** flag (`--include-dir`)
    2. `prefix/include`
    3. `/usr/gnu/include`
    4. `/usr/local/include`
    5. `/usr/include`
- _NOT_FOUND warnings/errors_ can be _**supressed with `-include` directive**_
- env variable `MAKEFILES` can be used to **preload other makefiles**
(spearated by whitespace)
